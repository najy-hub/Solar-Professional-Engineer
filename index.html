<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Permissions-Policy" content="browsing-topics=()">
  <title>منصة رحلة المهندس - نظام الدرب</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4895ef;
      --light-gray: #f8f9fa;
      --text-color: #333;
      --white: #ffffff;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
    }

    body {
      font-family: 'Cairo', sans-serif;
      background: var(--white);
      color: var(--text-color);
      margin: 0;
      padding: 0;
    }

    header, footer {
      background: var(--light-gray);
      padding: 20px;
      text-align: center;
      position: relative;
      border-bottom: 1px solid #e0e0e0;
    }

    .elegant-logout {
      background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      transition: all 0.3s ease;
      position: absolute;
      left: 20px;
      top: 20px;
    }

    .elegant-logout:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.15);
      background: linear-gradient(135deg, #ff5252, #ff7676);
    }

    .progress-container {
      background: var(--white);
      border-radius: 16px;
      padding: 20px;
      margin: 20px auto;
      max-width: 900px;
      box-shadow: var(--shadow);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      position: relative;
    }

    .progress-steps::before {
      content: '';
      position: absolute;
      top: 15px;
      left: 0;
      right: 0;
      height: 4px;
      background: #eee;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 2;
    }

    .step-icon {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .step.completed .step-icon {
      background: #4CAF50;
      color: white;
    }

    .step.current .step-icon {
      background: var(--primary-color);
      color: white;
      transform: scale(1.1);
    }

    .step-label {
      font-size: 12px;
      color: #666;
    }

    .course-sections {
      max-width: 900px;
      margin: 30px auto;
    }

    .section {
      margin-bottom: 20px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: var(--shadow);
    }

    .section-header {
      background: var(--primary-color);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .section-header h2 {
      margin: 0;
    }

    .section-content {
      background: var(--white);
      padding: 15px;
      display: none;
    }

    .week-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
    }

    .week-item.unlocked {
      background: var(--light-gray);
    }

    .week-item.locked {
      opacity: 0.6;
    }

    .week-item button {
      background: var(--accent-color);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .week-content {
      display: none;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }

    .video-list {
      list-style: none;
      padding: 0;
    }

    .video-item {
      margin-bottom: 30px;
      background: var(--white);
      border-radius: 10px;
      padding: 15px;
      box-shadow: var(--shadow);
    }

    .video-item h4 {
      margin-bottom: 10px;
      font-size: 18px;
      color: var(--primary-color);
    }

    .bunny-video-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      aspect-ratio: 16 / 9;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 20px auto;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      border: 1px solid #eee;
      transition: transform 0.3s ease;
    }

    .bunny-video-container:hover {
      transform: scale(1.01);
    }

    .bunny-video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: none;
    }

    .quiz {
      background: var(--light-gray);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .quiz a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: bold;
    }

    .quiz a:hover {
      text-decoration: underline;
    }

    .complete-btn {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 10px;
      transition: all 0.3s ease;
    }

    .complete-btn:hover {
      background: #3e8e41;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .week-navigation {
      text-align: center;
      margin: 30px auto;
    }

    .week-navigation button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin: 0 10px;
      font-size: 16px;
      transition: all 0.3s ease;
    }

    .week-navigation button:hover {
      background: var(--secondary-color);
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .lock-icon {
      color: #999;
    }

    .video-error {
      background: #ffebee;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
    }

    @media (max-width: 768px) {
      .progress-steps {
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
      }
      
      .progress-steps::before {
        display: none;
      }
      
      .section-header {
        padding: 12px 15px;
      }
      
      .week-navigation button {
        width: 100%;
        margin: 10px 0;
      }
      
      .elegant-logout {
        position: static;
        margin: 10px auto;
        display: inline-flex;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>مرحبا بك في دورة رحلة المهندس المحترف</h1>
    <button id="logoutBtn" class="elegant-logout">
      <i class="fas fa-sign-out-alt"></i>
      <span>تسجيل الخروج</span>
    </button>
  </header>

  <div class="progress-container">
    <div class="progress-header">
      <span>تقدمك في الدورة</span>
      <span id="progressText">0 من 14 أسابيع</span>
    </div>
    <div class="progress-steps" id="progressSteps"></div>
  </div>

  <div class="course-sections">
    <div class="section">
      <div class="section-header" onclick="toggleSection('basic')">
        <h2>القسم الأساسي (1-7)</h2>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="section-content" id="basic-section"></div>
    </div>
    
    <div class="section">
      <div class="section-header" onclick="toggleSection('pro')">
        <h2>القسم الاحترافي (8-14)</h2>
        <i class="fas fa-chevron-down"></i>
      </div>
      <div class="section-content" id="pro-section"></div>
    </div>
  </div>

  <main id="weeks"></main>

  <div class="week-navigation">
    <button onclick="navigateWeek(-1)"><i class="fas fa-arrow-right"></i> السابق</button>
    <button onclick="navigateWeek(1)">التالي <i class="fas fa-arrow-left"></i></button>
  </div>

  <footer>
    جميع الحقوق محفوظة &copy; 2025
  </footer>

 
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbxjzYkUaCWkOmn8hhr3fO-F_SEGlqmjVRNxWTnqFo96nyRlgVrRaW-S41vNKs11VejM9g/exec';


    // بيانات الدورة
    const courseData = {
      weeks: [
        // الأسبوع 0 غير مستخدم
        { // الأسبوع 1
          videos: [
            { title: "📘 Lec1: Principle of Operation", url: "https://iframe.mediadelivery.net/embed/460802/dce4ee28-5099-44df-9760-dddcf3609a95?autoplay=0" },
            { title: "📘 Lec2: Solar Technology", url: "https://iframe.mediadelivery.net/embed/460802/5c9229c6-4dc8-45cf-9b71-e6e4fce12da6?autoplay=0" },
            { title: "📘 Lec3: Area & Efficiency", url: "https://iframe.mediadelivery.net/embed/460802/7082d1ef-61a6-4ee4-82c0-ced096b8188f?autoplay=0" },
            { title: "📘 Lec4: Data sheet and Nameplate", url: "https://iframe.mediadelivery.net/embed/460802/4b7a1509-496d-4d39-ba3c-d635198fa551?autoplay=0" },
            { title: "📘 Lec5: Strategy Of Select Pv Panels", url: "https://iframe.mediadelivery.net/embed/460802/cfe04177-caf9-4e6c-a873-9691897b0fc8?autoplay=0" }
          ],
          quiz: "https://najy-hub.github.io/Assignment1/"
        },
        { // الأسبوع 2
          videos: [
            { title: "📘 Lec1: Behaviour of Electron", url: "https://iframe.mediadelivery.net/embed/460802/96a7baa2-15e4-46af-b385-a5ffdfa2e9be?autoplay=0" },
            { title: "📘 Lec2: Energy Bands", url: "https://iframe.mediadelivery.net/embed/460802/66b5260c-5552-4a88-8abb-69defa6ac944?autoplay=0" },
            { title: "📘 Lec3: Electron Journey1", url: "https://iframe.mediadelivery.net/embed/460802/747b6fb2-bc35-4b71-929c-fb16e82806c8?autoplay=0" },
            { title: "📘 Lec4: Electron Journey2", url: "https://iframe.mediadelivery.net/embed/460802/93af94fd-39b6-4527-9cac-5ca25bc6cd89?autoplay=0" }
          ],
          quiz: "https://najy-hub.github.io/Assignment2/"
        }
        // يمكن إضافة الأسابيع من 3 إلى 14 هنا
      
    };

    // المتغيرات العامة
    let currentUser = null;
    let currentWeek = 1;
    let unlockedWeeks = [1];
    let completedWeeks = [];

   // دالة تسجيل الدخول باستخدام Google Sheets
    async function login(email, password) {
      try {
        const response = await fetch(`${API_URL}?action=login`, {
          method: 'POST',
          body: JSON.stringify({ email, password }),
          headers: { 'Content-Type': 'application/json' }
        });
        
        const userData = await response.json();
        
        if (userData === "FAILED") {
          throw new Error("بيانات الدخول غير صحيحة");
        }
        
        // حفظ بيانات المستخدم في localStorage
        currentUser = {
          email: userData.email,
          uid: userData.email // نستخدم البريد كمعرف فريد
        };
        
        unlockedWeeks = userData.unlockedWeeks;
        completedWeeks = userData.completedWeeks;
        currentWeek = userData.currentWeek;
        
        localStorage.setItem('userData', JSON.stringify({
          email: userData.email,
          unlockedWeeks: userData.unlockedWeeks,
          completedWeeks: userData.completedWeeks,
          currentWeek: userData.currentWeek
        }));
        
        window.location.href = '/dashboard';
        
      } catch (error) {
        console.error("Login error:", error);
        alert("فشل تسجيل الدخول: " + error.message);
      }
    }

    // دالة تسجيل الخروج
    function logout() {
      localStorage.removeItem('userData');
      currentUser = null;
      window.location.href = '/login';
    }

    // دالة حفظ التقدم
    async function saveProgress() {
      if (!currentUser) return;
      
      try {
        await fetch(`${API_URL}?action=save`, {
          method: 'POST',
          body: JSON.stringify({
            email: currentUser.email,
            unlockedWeeks: unlockedWeeks,
            completedWeeks: completedWeeks,
            currentWeek: currentWeek
          }),
          headers: { 'Content-Type': 'application/json' }
        });
      } catch (error) {
        console.error("Error saving progress:", error);
      }
    }

    // دالة تحميل بيانات المستخدم
    function loadUserData() {
      const data = localStorage.getItem('userData');
      if (data) {
        const userData = JSON.parse(data);
        currentUser = { email: userData.email, uid: userData.email };
        unlockedWeeks = userData.unlockedWeeks || [1];
        completedWeeks = userData.completedWeeks || [];
        currentWeek = userData.currentWeek || 1;
        return true;
      }
      return false;
    }

    // تعديل دالة initPage للعمل مع النظام الجديد
    function initPage() {
      if (loadUserData()) {
        renderProgress();
        renderWeekList();
        loadWeek(currentWeek);
      } else {
        window.location.href = '/login';
      }
    }

    // بقية الدوال تبقى كما هي (renderProgress, renderWeekList, loadWeek, completeWeek, ...)

    // عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      initPage();
      document.getElementById('logoutBtn').addEventListener('click', logout);
    });
    // أضف هذه الدالة في مكان واضح في الكود
function toggleSection(sectionId) {
  const section = document.getElementById(`${sectionId}-section`);
  const icon = section.previousElementSibling.querySelector('i');
  
  if (section.style.display === 'block') {
    section.style.display = 'none';
    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
  } else {
    section.style.display = 'block';
    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
  }
}
    // دالة تبديل الأقسام
    function toggleSection(sectionId) {
      const section = document.getElementById(`${sectionId}-section`);
      const icon = section.previousElementSibling.querySelector('i');
      
      if (section.style.display === 'block') {
        section.style.display = 'none';
        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
      } else {
        section.style.display = 'block';
        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
      }
    }

    // دالة التنقل بين الأسابيع
    function navigateWeek(step) {
      const newWeek = currentWeek + step;
      if (newWeek >= 1 && newWeek <= 14) {
        loadWeek(newWeek);
      }
    }

    // دالة تسجيل الخروج
    function logout() {
      auth.signOut().then(() => {
        window.location.href = 'https://najy-hub.github.io/Login-Course/';
      });
    }
// إضافة دالة تسجيل الدخول بعد الخروج
   async function handleLogin(email, password) {
  try {
    // تأكد من تعيين الاستمرارية قبل تسجيل الدخول
   async function login(email, password) {
  try {
    // 1. تعيين استمرارية الجلسة أولاً
    await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    
    // 2. تسجيل الدخول
    const userCredential = await auth.signInWithEmailAndPassword(email, password);
    currentUser = userCredential.user;
    
    // 3. تأخير التوجيه لضمان حفظ الحالة
    setTimeout(() => {
      window.location.href = 'https://course.najyacademia.com/';
    }, 1500); // زيادة زمن التأخير
    
    return true;
  } catch (error) {
    console.error("كود الخطأ:", error.code, "الرسالة:", error.message);
    alert(`فشل تسجيل الدخول: ${error.message}`);
    return false;
  }
}
    // أضف هذا في صفحة تسجيل الخروج
async function logout() {
  try {
    console.log("بدء عملية تسجيل الخروج");
    
    // 1. أولاً: إعادة التوجيه إلى صفحة تسجيل الدخول
    window.location.href = 'https://login.najyacademia.com/';
    
    // 2. ثانياً: تسجيل الخروج (بعد التأخير)
    setTimeout(async () => {
      try {
        await auth.signOut();
        console.log("تم تسجيل الخروج بنجاح");
        
        // مسح التخزين المحلي
        window.localStorage.removeItem('firebase:authUser:AIzaSyBWdrUtLP4fVKHDmQDC6nUJzBMPA7AmbMc:[DEFAULT]');
        if (window.indexedDB) {
          indexedDB.deleteDatabase("firebaseLocalStorageDb");
        }
      } catch (error) {
        console.error("حدث خطأ أثناء تسجيل الخروج:", error);
      }
    }, 1000); // تأخير 1 ثانية
    
  } catch (error) {
    console.error("خطأ في عملية تسجيل الخروج:", error);
  }
}
    // دالة عرض التقدم
    function renderProgress() {
      const progressText = document.getElementById('progressText');
      const progressSteps = document.getElementById('progressSteps');
      
      progressText.textContent = `${completedWeeks.length} من 14 أسابيع`;
      
      progressSteps.innerHTML = '';
      for (let i = 1; i <= 14; i++) {
        const step = document.createElement('div');
        step.className = `step ${completedWeeks.includes(i) ? 'completed' : ''} ${i === currentWeek ? 'current' : ''}`;
        step.innerHTML = `
          <div class="step-icon">${completedWeeks.includes(i) ? '✓' : i}</div>
          <div class="step-label">الأسبوع ${i}</div>
        `;
        progressSteps.appendChild(step);
      }
    }

    // دالة عرض قائمة الأسابيع
    function renderWeekList() {
      const basicSection = document.getElementById('basic-section');
      const proSection = document.getElementById('pro-section');
      
      basicSection.innerHTML = '';
      proSection.innerHTML = '';
      
      for (let i = 1; i <= 14; i++) {
        const weekItem = document.createElement('div');
        weekItem.className = `week-item ${unlockedWeeks.includes(i) ? 'unlocked' : 'locked'}`;
        weekItem.innerHTML = `
          <span>الأسبوع ${i}</span>
          ${unlockedWeeks.includes(i) ? 
            `<button onclick="loadWeek(${i})">فتح</button>` : 
            `<span class="lock-icon">🔒</span>`}
        `;
        
        if (i <= 7) {
          basicSection.appendChild(weekItem);
        } else {
          proSection.appendChild(weekItem);
        }
      }
    }

    // دالة التحقق من صحة الرابط
    function isValidUrl(url) {
      try {
        new URL(url);
        return true;
      } catch {
        return false;
      }
    }

    // دالة تحميل محتوى الأسبوع
    async function loadWeek(weekNumber) {
      if (!unlockedWeeks.includes(weekNumber)) {
        alert('هذا الأسبوع غير متاح لك بعد');
        return;
      }
      
      currentWeek = weekNumber;
      await saveProgress();
      
      const weekData = courseData.weeks[weekNumber];
      const weeksContainer = document.getElementById('weeks');
      
      weeksContainer.innerHTML = '';
      
      if (!weekData) {
        weeksContainer.innerHTML = '<p>المحتوى قيد التجهيز</p>';
        return;
      }
      
      const weekDiv = document.createElement('div');
      weekDiv.className = 'week-content';
      weekDiv.style.display = 'block';
      
      const title = document.createElement('h2');
      title.textContent = `الأسبوع ${weekNumber} - ${weekNumber <= 7 ? 'الأساسي' : 'الاحترافي'}`;
      weekDiv.appendChild(title);
      
      const videoList = document.createElement('ul');
      videoList.className = 'video-list';
      
      if (weekData.videos && weekData.videos.length > 0) {
        weekData.videos.forEach(video => {
          const videoItem = document.createElement('li');
          videoItem.className = 'video-item';
          
          if (isValidUrl(video.url)) {
            videoItem.innerHTML = `
              <h4>${video.title}</h4>
              <div class="bunny-video-container">
                <iframe src="${encodeURI(video.url)}" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen
                        loading="lazy"></iframe>
              </div>
            `;
          } else {
            videoItem.innerHTML = `
              <h4>${video.title}</h4>
              <div class="video-error">
                <p>عذراً، لا يمكن تحميل الفيديو حالياً</p>
                <a href="${video.url}" target="_blank">جرب فتح الرابط في نافذة جديدة</a>
              </div>
            `;
          }
          
          videoList.appendChild(videoItem);
        });
      } else {
        videoList.innerHTML = '<p>لا توجد فيديوهات متاحة لهذا الأسبوع</p>';
      }
      
      weekDiv.appendChild(videoList);
      
      if (weekData.quiz) {
        const quizDiv = document.createElement('div');
        quizDiv.className = 'quiz';
        quizDiv.innerHTML = `
          <h3>📝 اختبار الأسبوع</h3>
          <p><a href="${weekData.quiz}" target="_blank">رابط الاختبار</a></p>
          <button onclick="completeWeek(${weekNumber})" class="complete-btn">تم الانتهاء من الأسبوع</button>
        `;
        weekDiv.appendChild(quizDiv);
      }
      
      weeksContainer.appendChild(weekDiv);
      renderProgress();
    }

    // دالة إكمال الأسبوع
    async function completeWeek(weekNumber) {
      if (!completedWeeks.includes(weekNumber)) {
        completedWeeks.push(weekNumber);
        
        // فتح الأسبوع التالي إذا كان موجوداً
        const nextWeek = weekNumber + 1;
        if (nextWeek <= 14 && !unlockedWeeks.includes(nextWeek)) {
          unlockedWeeks.push(nextWeek);
        }
        
        await saveProgress();
        renderProgress();
        renderWeekList();
        alert(`تهانينا! لقد أكملت الأسبوع ${weekNumber}`);
      }
    }

    // دالة تهيئة الصفحة
    function initPage() {
      renderProgress();
      renderWeekList();
      loadWeek(currentWeek);
    }

    // عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
      auth.onAuthStateChanged(async (user) => {
        if (user) {
          currentUser = user;
          await loadUserData();
          initPage();
        } else {
          window.location.href = 'https://login.najyacademia.com/';
        }
      });

      document.getElementById('logoutBtn').addEventListener('click', logout);
      
      // فتح القسم الأساسي تلقائياً عند التحميل
      document.getElementById('basic-section').style.display = 'block';
      document.querySelector('.section-header i').classList.replace('fa-chevron-down', 'fa-chevron-up');
    });
  </script>
</body>
</html>
